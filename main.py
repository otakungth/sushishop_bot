import os
import datetime
import discord
from discord.ext import commands
from discord.ui import View, Button, Modal, TextInput
import re

from server import server_on

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏ó
gamepass_rate = 6
group_rate_low = 4
group_rate_high = 4.5

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
intents = discord.Intents.default()
intents.message_content = True
intents.guilds = True
intents.members = True
shop_open = True

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞ stock
MAIN_CHANNEL_ID = 1361044752975532152  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ID ‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
SALES_LOG_CHANNEL_ID = 1402993077643120720
stock_amount = 100  # ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô stock ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

bot = commands.Bot(command_prefix="!", intents=intents)

# --------------------------------------------------------------------------------------------------
# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
async def send_sale_log(embed_data: discord.Embed, interaction: discord.Interaction = None, ctx: commands.Context = None, delivered_by: discord.Member = None):
    """‡∏™‡πà‡∏á Embed ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"""
    try:
        channel = bot.get_channel(SALES_LOG_CHANNEL_ID)
        if channel is None:
            print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢")
            return

        # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Embed ‡πÄ‡∏î‡∏¥‡∏°
        robux_amount = next((f.value for f in embed_data.fields if f.name == "üí∏ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Robux"), "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö")
        price = next((f.value for f in embed_data.fields if f.name in ("üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡∏ó", "üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤")), "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö")
        user_name = next((f.value for f in embed_data.fields if f.name == "üòä ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠"), "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö")

        # ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        sale_type = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"
        current_channel = interaction.channel if interaction else ctx.channel if ctx else None
        if current_channel:
            category_name = current_channel.category.name if current_channel.category else ""
            if "gamepass" in category_name.lower():
                sale_type = "Robux Gamepass"
            elif "group" in category_name.lower():
                sale_type = "Robux Group"

        # ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡πã‡∏ß
        ticket_creator = None
        if current_channel and current_channel.name.startswith("ticket-"):
            try:
                user_id = int(current_channel.name.split("-")[-1])
                ticket_creator = await current_channel.guild.fetch_member(user_id)
            except (IndexError, ValueError, discord.NotFound):
                pass

        # ‡∏™‡∏£‡πâ‡∏≤‡∏á Embed ‡πÉ‡∏´‡∏°‡πà
        log_embed = discord.Embed(
            title="üç£ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üç£",
            color=0x00FF00,
            timestamp=discord.utils.utcnow()
        )
        log_embed.add_field(name="üì¶ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", value=sale_type, inline=False)
        log_embed.add_field(name="üòä ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠", value=ticket_creator.mention if ticket_creator else user_name, inline=False)
        log_embed.add_field(name="üí∏ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Robux", value=robux_amount, inline=True)
        log_embed.add_field(name="üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤", value=price, inline=True)
        log_embed.add_field(name="üöö ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", value=delivered_by.mention if delivered_by else "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö", inline=False)
        log_embed.set_footer(text="‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")

        await channel.send(embed=log_embed)

    except Exception as e:
        print(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: {e}")

# --------------------------------------------------------------------------------------------------
# ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Stock
@bot.command()
@commands.has_permissions(administrator=True)
async def stock(ctx, amount: int = None):
    """‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô stock (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)"""
    global stock_amount
    
    if amount is None:
        await ctx.send(f"üìä Stock ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: **{stock_amount}**", delete_after=10)
        return
    
    if amount < 0:
        await ctx.send("‚ùå ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô stock ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0", delete_after=5)
        return
    
    stock_amount = amount
    await ctx.send(f"‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ stock ‡πÄ‡∏õ‡πá‡∏ô **{stock_amount}** ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", delete_after=5)
    
    # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å
    await update_main_channel()

# --------------------------------------------------------------------------------------------------
# ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô
@bot.command()
@commands.has_permissions(administrator=True)
async def sushi(ctx):
    """‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á Gamepass ‡πÅ‡∏•‡∏∞ Group)"""
    global shop_open
    shop_open = not shop_open

    status = "‚úÖ ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏¥‡∏î" if shop_open else "‚ùå ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î"
    await ctx.send(
        f"üìå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô: **{status}**",
        delete_after=5
    )

    if ctx.channel.id == MAIN_CHANNEL_ID:
        await update_main_channel()

# --------------------------------------------------------------------------------------------------
# ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å
async def update_main_channel():
    """‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å"""
    channel = bot.get_channel(MAIN_CHANNEL_ID)
    if not channel:
        return

    # ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏≤‡πÜ ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ
    async for msg in channel.history(limit=20):
        if msg.author == bot.user:
            await msg.delete()

    # ‡∏™‡∏£‡πâ‡∏≤‡∏á embed ‡∏´‡∏•‡∏±‡∏Å
    embed = discord.Embed(
        title="üç£ Sushi Shop üç£",
        color=0xFFD700
    )
    
    # ‡∏™‡πà‡∏ß‡∏ô Gamepass
    embed.add_field(
        name="üéÆ Gamepass",
        value=(
            f"‡πÄ‡∏£‡∏ó **{gamepass_rate}**\n"
            "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß Gamepass' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÄ‡∏Å‡∏°‡∏û‡∏≤‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö\n\n"
            "‡∏´‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏¥‡∏î‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"
        ),
        inline=False
    )
    
    # ‡∏™‡πà‡∏ß‡∏ô Group
    embed.add_field(
        name="üë• Robux Group", 
        value=(
            f"üõí ‡πÇ‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏ó **{group_rate_low}** ‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 500 ‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏ó **{group_rate_high}**\n"
            "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß Group' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö\n\n"
            "‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ: https://www.roblox.com/communities/34713179/VALKYs\n\n"
            "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 15 ‡∏ß‡∏±‡∏ô ‚ö†Ô∏è\n\n"
            f"üìå ‡∏à‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà <#1387421905941827615>\n\n"
            "‡∏´‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö"
        ),
        inline=False
    )
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏° stock
    embed.add_field(
        name="üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Stock",
        value=f"**{stock_amount}**",
        inline=False
    )
    
    embed.set_thumbnail(
        url="https://media.discordapp.net/attachments/717757556889747657/1403684950770847754/noFilter.png"
    )

    # ‡∏™‡πà‡∏á embed ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°
    await channel.send(embed=embed, view=MainShopView())

# --------------------------------------------------------------------------------------------------
# Views ‡πÅ‡∏•‡∏∞ Modals ‡∏´‡∏•‡∏±‡∏Å
class MainShopView(View):
    def __init__(self):
        super().__init__(timeout=None)
        self.update_buttons()

    def update_buttons(self):
        self.clear_items()
        
        if shop_open and stock_amount > 0:
            self.add_item(Button(label="‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß Gamepass", style=discord.ButtonStyle.success, custom_id="open_gamepass_ticket"))
            self.add_item(Button(label="‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß Group", style=discord.ButtonStyle.primary, custom_id="open_group_ticket"))
        else:
            self.add_item(Button(label="‚ùå ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß", style=discord.ButtonStyle.danger, disabled=True))

# --------------------------------------------------------------------------------------------------
# Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Gamepass
class GamepassTicketModal(Modal, title="üìã ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ Gamepass"):
    map_name = TextInput(
        label="üó∫ ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏°‡∏û‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Å‡∏î?",
        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏°‡∏û ‡πÄ‡∏ä‡πà‡∏ô All Star Tower Defense X",
        required=True
    )
    gamepass_name = TextInput(
        label="üí∏ ‡∏Å‡∏î‡πÄ‡∏Å‡∏°‡∏û‡∏≤‡∏™‡∏≠‡∏∞‡πÑ‡∏£?",
        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏û‡∏≤‡∏™ ‡πÄ‡∏ä‡πà‡∏ô x3 Speed 3 ‡∏ä‡∏¥‡πâ‡∏ô",
        required=True
    )
    robux_amount = TextInput(
        label="üéü ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏µ‡πà Robux?",
        placeholder="‡πÄ‡∏ä‡πà‡∏ô 995 ‡∏´‡∏£‡∏∑‡∏≠ 100+100+100 ‡∏´‡∏£‡∏∑‡∏≠ 100x3",
        required=True
    )

    async def on_submit(self, interaction: discord.Interaction):
        try:
            # ‡πÅ‡∏õ‡∏•‡∏á input ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö x ‡πÅ‡∏•‡∏∞ √∑
            expr = self.robux_amount.value.lower().replace("x", "*").replace("√∑", "/")

            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ input ‡∏°‡∏µ‡πÅ‡∏ï‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
            if not re.match(r"^[\d\s\+\-\*\/\(\)]+$", expr):
                await interaction.response.send_message("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ + - * / x √∑ ()", ephemeral=True)
                return

            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì robux
            robux = int(eval(expr))
            price = robux / gamepass_rate
            price_str = f"{price:,.0f} ‡∏ö‡∏≤‡∏ó"

            # Embed ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            customer_embed = discord.Embed(title="üì® ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ Gamepass", color=0x00FF99)
            customer_embed.add_field(name="üó∫Ô∏è ‡πÅ‡∏°‡∏û", value=self.map_name.value, inline=False)
            customer_embed.add_field(name="üéü ‡πÄ‡∏Å‡∏°‡∏û‡∏≤‡∏™", value=self.gamepass_name.value, inline=False)
            customer_embed.add_field(name="üí∏ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Robux", value=f"{robux:,}", inline=True)
            customer_embed.add_field(name="üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤", value=price_str, inline=True)
            customer_embed.set_footer(text="‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏£‡∏±‡∏ö")

            # Embed ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            confirm_embed = customer_embed.copy()
            confirm_embed.set_footer(text=f"üßæ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {interaction.user}")

            view = ConfirmTicketView(embed_data=confirm_embed)
            await interaction.response.send_message(embed=customer_embed, view=view, ephemeral=False)

        except Exception as e:
            await interaction.response.send_message(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}", ephemeral=True)

# --------------------------------------------------------------------------------------------------
# Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Group
class GroupTicketModal(Modal, title="üìã ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ Robux Group"):
    user_name = TextInput(
        label="ü™™ ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏°", 
        placeholder="Username", 
        required=True
    )
    robux_amount = TextInput(
        label="üí∏ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏µ‡πà Robux?", 
        placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Robux ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", 
        required=True
    )

    async def on_submit(self, interaction: discord.Interaction):
        try:
            robux = int(self.robux_amount.value)
            rate = group_rate_low if robux < 1500 else group_rate_high
            price = robux / rate
            price_str = f"{price:,.0f} ‡∏ö‡∏≤‡∏ó"

            customer_embed = discord.Embed(title="üì® ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ Robux Group", color=0x00FF99)
            customer_embed.add_field(name="ü™™ ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏°", value=self.user_name.value, inline=False)
            customer_embed.add_field(name="üí∏ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Robux", value=f"{robux:,}", inline=True)
            customer_embed.add_field(name="üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤", value=price_str, inline=True)
            customer_embed.set_footer(text="‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏£‡∏±‡∏ö")

            confirm_embed = customer_embed.copy()
            confirm_embed.set_footer(text=f"üßæ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {interaction.user}")

            view = ConfirmTicketView(embed_data=confirm_embed)
            await interaction.response.send_message(embed=customer_embed, view=view, ephemeral=False)

        except ValueError:
            await interaction.response.send_message("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Robux ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç", ephemeral=True)

# --------------------------------------------------------------------------------------------------
# View ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡πã‡∏ß
class ConfirmTicketView(View):
    def __init__(self, embed_data: discord.Embed):
        super().__init__(timeout=None)
        self.embed_data = discord.Embed.from_dict(embed_data.to_dict())

    @discord.ui.button(label="‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", style=discord.ButtonStyle.success, custom_id="confirm_ticket")
    async def confirm_button(self, interaction: discord.Interaction, button: Button):
        role_id = 1361016912259055896
        role = interaction.guild.get_role(role_id)
        if role not in interaction.user.roles:
            await interaction.response.send_message("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ", ephemeral=True)
            return

        if any(field.name == "üìã ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏î‡∏¢" for field in self.embed_data.fields):
            await interaction.response.send_message("‚ö†Ô∏è ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß", ephemeral=True)
            return

        self.embed_data.add_field(name="üìã ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏î‡∏¢", value=interaction.user.mention, inline=False)
        await send_sale_log(self.embed_data, interaction=interaction, delivered_by=interaction.user)

        await interaction.response.send_message("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", ephemeral=True)
        await interaction.message.edit(view=None)

    @discord.ui.button(label="‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", style=discord.ButtonStyle.danger, custom_id="cancel_ticket")
    async def cancel_button(self, interaction: discord.Interaction, button: Button):
        cancel_embed = discord.Embed(
            title="‚ùå ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
            description=f"‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏¢ {interaction.user.mention}",
            color=0xFF0000
        )
        await interaction.response.send_message(embed=cancel_embed)
        await interaction.message.edit(view=None)

# --------------------------------------------------------------------------------------------------
# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß
class GoToTicketView(discord.ui.View):
    def __init__(self, channel):
        super().__init__(timeout=None)
        self.add_item(
            discord.ui.Button(
                label="‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πã‡∏ß",
                url=channel.jump_url,
                style=discord.ButtonStyle.link
            )
        )

async def handle_open_ticket(interaction, category_name, view_class, modal_class, mention_user=False):
    global stock_amount
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö stock
    if stock_amount <= 0:
        await interaction.response.send_message("‚ùå ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß", ephemeral=True)
        return
        
    guild = interaction.guild
    user = interaction.user

    if guild is None:
        await interaction.response.send_message("‚ùå ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå", ephemeral=True)
        return

    channel_name = f"ticket-{user.name}-{user.id}"
    existing_channel = discord.utils.get(guild.text_channels, name=channel_name)

    if isinstance(user, discord.Member) and existing_channel and existing_channel.permissions_for(user).read_messages:
        await interaction.response.send_message("üìå ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏ï‡∏±‡πã‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!", ephemeral=True)
        return

    overwrites = {
        guild.default_role: discord.PermissionOverwrite(read_messages=False),
        guild.me: discord.PermissionOverwrite(read_messages=True, send_messages=True),
        user: discord.PermissionOverwrite(read_messages=True, send_messages=True)
    }

    admin_role = guild.get_role(1361016912259055896)
    if admin_role:
        overwrites[admin_role] = discord.PermissionOverwrite(read_messages=True, send_messages=True)

    category = discord.utils.get(guild.categories, name=category_name)
    if category is None:
        await interaction.response.send_message(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà {category_name}", ephemeral=True)
        return

    channel = await guild.create_text_channel(
        name=channel_name,
        overwrites=overwrites,
        reason="New ticket",
        category=category
    )
    
    # ‡∏•‡∏î stock
    stock_amount -= 1
    await update_main_channel()
    
    await interaction.response.send_message(
        content="üì© ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!",
        view=GoToTicketView(channel),
        ephemeral=True
    )

    if admin_role:
        await channel.send(content=admin_role.mention)

    welcome_embed = discord.Embed(
        title="üç£ Sushi Shop üç£",
        description=(
            "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ :\n\n"
            f"{user.mention}\n\n"
            "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô :\n\n"
            f"{admin_role.mention if admin_role else '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'}\n\n"
            "** üéüÔ∏è ‡∏™‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ **\n\n"
            "‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á\n"
            "!gp ‡πÄ‡∏ä‡πà‡∏ô : ''!gp 799 / !gp 299+599 / !gp 59x7''"
        ),
        color=0x00FF99
    )
    welcome_embed.set_thumbnail(url="https://cdn.discordapp.com/attachments/717757556889747657/1403684950770847754/noFilter.png")
    welcome_embed.set_footer(text="Sushi Shop Service")

    await channel.send(embed=welcome_embed, view=view_class(channel, user, modal_class))

# --------------------------------------------------------------------------------------------------
# View ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πã‡∏ß
class TicketActionView(View):
    def __init__(self, channel: discord.TextChannel, owner: discord.Member, modal_class):
        super().__init__(timeout=None)
        self.channel = channel
        self.owner = owner
        self.modal_class = modal_class

    @discord.ui.button(label="üìù ‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°", style=discord.ButtonStyle.primary)
    async def open_form(self, interaction: discord.Interaction, button: Button):
        await interaction.response.send_modal(self.modal_class())

    @discord.ui.button(label="üì§ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", style=discord.ButtonStyle.success)
    async def payment_info(self, interaction: discord.Interaction, button: Button):
        embed = discord.Embed(title="üì§ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô").set_image(
            url="https://media.discordapp.net/attachments/722832040860319835/1402994996600111114/186-8-06559-8.png"
        )
        await interaction.response.send_message(embed=embed, ephemeral=True)

    @discord.ui.button(label="üîí ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß", style=discord.ButtonStyle.danger)
    async def close_ticket(self, interaction: discord.Interaction, button: Button):
        if interaction.user.id != self.owner.id:
            await interaction.response.send_message("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡πã‡∏ß‡∏ô‡∏µ‡πâ", ephemeral=True)
            return

        await interaction.response.send_message("üì™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß‡πÉ‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...", ephemeral=True)
        await discord.utils.sleep_until(discord.utils.utcnow() + datetime.timedelta(seconds=5))
        
        # ‡∏Ñ‡∏∑‡∏ô stock ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß
        global stock_amount
        stock_amount += 1
        await update_main_channel()
        
        await self.channel.delete()

# --------------------------------------------------------------------------------------------------
# Events
@bot.event
async def on_ready():
    print(f"‚úÖ ‡∏ö‡∏≠‡∏ó‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß: {bot.user}")
    await bot.change_presence(activity=discord.Activity(type=discord.ActivityType.watching, name="‡∏£‡πâ‡∏≤‡∏ô Sushi Shop"))
    await update_main_channel()

@bot.event
async def on_interaction(interaction: discord.Interaction):
    if not interaction.data:
        return

    custom_id = interaction.data.get("custom_id")

    if custom_id == "open_gamepass_ticket":
        await handle_open_ticket(
            interaction,
            category_name="üç£Sushi Gamepass üç£",
            view_class=TicketActionView,
            modal_class=GamepassTicketModal,
            mention_user=True
        )

    elif custom_id == "open_group_ticket":
        await handle_open_ticket(
            interaction,
            category_name="üí∞Robux Groupüí∞",
            view_class=TicketActionView,
            modal_class=GroupTicketModal,
            mention_user=False
        )

# --------------------------------------------------------------------------------------------------
# ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)
async def send_ephemeral_calculation(ctx, calculation_func, expression, product_type):
    """‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"""
    try:
        expression = expression.replace(",", "").lower().replace("x", "*").replace("√∑", "/")

        if not re.match(r"^[\d\s\+\-\*\/\(\)]+$", expression):
            await ctx.send("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ + - * / x √∑ ()", ephemeral=True)
            return

        result = calculation_func(expression)
        await ctx.send(result, ephemeral=True)

    except Exception as e:
        await ctx.send(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}", ephemeral=True)

def calculate_gp(expression):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ Gamepass"""
    robux = eval(expression)
    price = robux / gamepass_rate
    return f"üéÆ Gamepass {robux:,} Robux = **{price:,.0f} ‡∏ö‡∏≤‡∏ó** (‡πÄ‡∏£‡∏ó {gamepass_rate})"

def calculate_g(expression):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ Group"""
    robux = eval(expression)
    rate = group_rate_low if robux < 1500 else group_rate_high
    price = robux / rate
    return f"üë• Group {robux:,} Robux = **{price:,.0f} ‡∏ö‡∏≤‡∏ó** (‡πÄ‡∏£‡∏ó {rate})"

def calculate_gpb(expression):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô Robux (Gamepass)"""
    baht = eval(expression)
    robux = baht * gamepass_rate
    return f"üéÆ {baht:,.0f} ‡∏ö‡∏≤‡∏ó = **{robux:,.0f} Robux** (Gamepass ‡πÄ‡∏£‡∏ó {gamepass_rate})"

def calculate_gb(expression):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô Robux (Group)"""
    baht = eval(expression)
    rate = group_rate_low if baht < 500 else group_rate_high
    robux = baht * rate
    return f"üë• {baht:,.0f} ‡∏ö‡∏≤‡∏ó = **{robux:,.0f} Robux** (Group ‡πÄ‡∏£‡∏ó {rate})"

# ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
@bot.command()
async def gp(ctx, *, expression: str):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Robux (Gamepass) - ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì"""
    await send_ephemeral_calculation(ctx, calculate_gp, expression, "Gamepass")

@bot.command()
async def g(ctx, *, expression: str):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Robux (Group) - ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì"""
    await send_ephemeral_calculation(ctx, calculate_g, expression, "Group")

@bot.command()
async def gpb(ctx, *, expression: str):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏õ‡πá‡∏ô Robux (Gamepass) - ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì"""
    await send_ephemeral_calculation(ctx, calculate_gpb, expression, "Gamepass")

@bot.command()
async def gb(ctx, *, expression: str):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏õ‡πá‡∏ô Robux (Group) - ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì"""
    await send_ephemeral_calculation(ctx, calculate_gb, expression, "Group")

# --------------------------------------------------------------------------------------------------
# ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
@bot.command()
@commands.has_permissions(administrator=True)
async def qr(ctx):
    embed = discord.Embed(
        title="üì± ‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô",
        description="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ",
        color=0x00CCFF)
    embed.set_image(url="https://media.discordapp.net/attachments/722832040860319835/1402994996600111114/186-8-06559-8.png")
    await ctx.send(embed=embed)
    await ctx.message.delete()

@bot.command()
@commands.has_permissions(administrator=True)
async def ty(ctx):
    if ctx.channel.name.startswith("ticket-"):
        # ‡∏Ñ‡∏∑‡∏ô stock ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        global stock_amount
        stock_amount += 1
        await update_main_channel()
        
        # ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°...
        sale_embed = None
        async for msg in ctx.channel.history():
            if msg.embeds and "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" in msg.embeds[0].title:
                sale_embed = msg.embeds[0]
                break

        if sale_embed:
            confirmed = any(field.name == "üìã ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏î‡∏¢" for field in sale_embed.fields)
            if not confirmed:
                sale_embed.add_field(name="üìã ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏î‡∏¢", value=ctx.author.mention, inline=False)

        delivered_category = discord.utils.get(ctx.guild.categories, name="‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß")
        if delivered_category:
            try:
                await ctx.channel.edit(category=delivered_category)
            except Exception as e:
                print(f"‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: {e}")

        embed = discord.Embed(
            title="‚úÖ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
            description=(
                "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤ ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° "
                "‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢\n\n"
                "‚è≥ **‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß ‡∏ï‡∏±‡πã‡∏ß‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á**"
            ),
            color=0x00FF00
        )
        await ctx.send(embed=embed, view=CloseTicketView(ctx.channel))

        async def auto_close():
            await discord.utils.sleep_until(discord.utils.utcnow() + datetime.timedelta(hours=1))
            if ctx.channel and ctx.channel.name.startswith("ticket-"):
                try:
                    await ctx.send("‚è≥ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö ‡∏ï‡∏±‡πã‡∏ß‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")
                    await ctx.channel.delete()
                except:
                    pass

        bot.loop.create_task(auto_close())

    await ctx.message.delete()

@bot.command()
@commands.has_permissions(administrator=True)
async def closeticket(ctx):
    if ctx.channel.name.startswith("ticket-"):
        # ‡∏Ñ‡∏∑‡∏ô stock ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß
        global stock_amount
        stock_amount += 1
        await update_main_channel()
        
        sale_embed = None
        async for msg in ctx.channel.history():
            if msg.embeds and "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" in msg.embeds[0].title:
                sale_embed = msg.embeds[0]
                break

        if sale_embed:
            await send_sale_log(sale_embed, ctx=ctx)

        await ctx.send("üì™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß‡πÉ‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...")
        await ctx.message.delete()
        await discord.utils.sleep_until(discord.utils.utcnow() + datetime.timedelta(seconds=5))
        await ctx.channel.delete()
    else:
        await ctx.message.delete()

class CloseTicketView(discord.ui.View):
    def __init__(self, channel: discord.TextChannel):
        super().__init__(timeout=None)
        self.channel = channel

        self.add_item(discord.ui.Button(
            label="üìå ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï",
            style=discord.ButtonStyle.success,
            url="https://discord.com/channels/1360990259311018077/1361049580736745502"
        ))

    @discord.ui.button(label="üîí ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß", style=discord.ButtonStyle.danger)
    async def close_ticket_button(self, interaction: discord.Interaction, button: discord.ui.Button):
        # ‡∏Ñ‡∏∑‡∏ô stock ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß
        global stock_amount
        stock_amount += 1
        await update_main_channel()
        
        await interaction.response.send_message("üì™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πã‡∏ß‡πÉ‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...", ephemeral=True)
        await discord.utils.sleep_until(discord.utils.utcnow() + datetime.timedelta(seconds=5))
        await self.channel.delete()

# --------------------------------------------------------------------------------------------------
server_on()
bot.run(os.getenv("TOKEN"))
