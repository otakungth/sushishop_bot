import os
import datetime
import discord
from discord.ext import commands
from discord.ui import View, Button, Modal, TextInput, Select
import re
import json
import asyncio

from server import server_on

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Intents ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
intents = discord.Intents.all()
intents.message_content = True

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏ó
gamepass_rate = 6
group_rate_low = 4
group_rate_high = 4.5

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
shop_open = True
group_ticket_enabled = True

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞ stock
MAIN_CHANNEL_ID = 1361044752975532152
SALES_LOG_CHANNEL_ID = 1402993077643120720
gamepass_stock = 67
group_stock = 67

# ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ô‡πâ‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
user_notes = {}

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏≠‡∏ó‡∏î‡πâ‡∏ß‡∏¢ intents ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
bot = commands.Bot(
    command_prefix="!", 
    intents=intents,
    help_command=None
)

# --------------------------------------------------------------------------------------------------
# Events ‡∏´‡∏•‡∏±‡∏Å
@bot.event
async def on_connect():
    print("üîó ‡∏ö‡∏≠‡∏ó‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Discord ‡πÅ‡∏•‡πâ‡∏ß")

@bot.event
async def on_ready():
    print(f"‚úÖ ‡∏ö‡∏≠‡∏ó‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß: {bot.user.name}")
    print(f"üÜî ID: {bot.user.id}")
    print(f"üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö {len(bot.guilds)} ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå")
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á text ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    for guild in bot.guilds:
        print(f"üè† ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: {guild.name}")
        for channel in guild.text_channels:
            print(f"   üìÅ {channel.name} ({channel.id})")
    
    await bot.change_presence(activity=discord.Activity(type=discord.ActivityType.watching, name="‡∏£‡πâ‡∏≤‡∏ô Sushi Shop"))
    
    # ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Persistent View
    bot.add_view(MainShopView())
    print("‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô MainShopView ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
    
    await update_main_channel()

@bot.event
async def on_message(message):
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ö‡∏≠‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if message.author == bot.user:
        return
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if message.content.startswith('!'):
        print(f"üì® ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: {message.content} ‡∏à‡∏≤‡∏Å {message.author} ‡πÉ‡∏ô #{message.channel.name}")
    
    # ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    await bot.process_commands(message)

@bot.event
async def on_command_error(ctx, error):
    """‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á"""
    if isinstance(error, commands.CommandNotFound):
        await ctx.send("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå `!help` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", delete_after=10)
    elif isinstance(error, commands.MissingPermissions):
        await ctx.send("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ", delete_after=10)
    else:
        print(f"‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á {ctx.command}: {error}")
        await ctx.send("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á", delete_after=10)

# --------------------------------------------------------------------------------------------------
# ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö
@bot.command()
async def test(ctx):
    """‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ"""
    try:
        await ctx.send("‚úÖ ‡∏ö‡∏≠‡∏ó‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥! ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ")
        print(f"‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÇ‡∏î‡∏¢ {ctx.author}")
    except Exception as e:
        print(f"‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á test: {e}")

@bot.command()
async def ping(ctx):
    """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö latency ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó"""
    latency = round(bot.latency * 1000)
    await ctx.send(f"üèì Pong! {latency}ms")

@bot.command()
async def help(ctx):
    """‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"""
    embed = discord.Embed(
        title="üç£ Sushi Shop - ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
        description="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ",
        color=0x00FF99
    )
    
    embed.add_field(
        name="üéÆ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤",
        value=(
            "`!gp <‡∏à‡∏≥‡∏ô‡∏ß‡∏ô>` - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ Gamepass\n"
            "`!g <‡∏à‡∏≥‡∏ô‡∏ß‡∏ô>` - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ Group\n"
            "`!gpb <‡∏à‡∏≥‡∏ô‡∏ß‡∏ô>` - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Robux ‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô (Gamepass)\n"
            "`!gb <‡∏à‡∏≥‡∏ô‡∏ß‡∏ô>` - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Robux ‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô (Group)\n"
            "`!tax <‡∏à‡∏≥‡∏ô‡∏ß‡∏ô>` - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Robux ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ"
        ),
        inline=False
    )
    
    embed.add_field(
        name="‚öôÔ∏è ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•",
        value=(
            "`!stock` - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö stock\n"
            "`!stock gp <‡∏à‡∏≥‡∏ô‡∏ß‡∏ô>` - ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Gamepass stock\n"
            "`!stock group <‡∏à‡∏≥‡∏ô‡∏ß‡∏ô>` - ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Group stock\n"
            "`!sushi` - ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô\n"
            "`!group <on/off>` - ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Group ticket\n"
            "`!restart` - ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏∏‡πà‡∏°"
        ),
        inline=False
    )
    
    await ctx.send(embed=embed)

# --------------------------------------------------------------------------------------------------
# ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
@bot.command()
@commands.has_permissions(administrator=True)
async def stock(ctx, stock_type: str = None, amount: int = None):
    """‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô stock (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)"""
    global gamepass_stock, group_stock
    
    try:
        await ctx.message.delete()
    except:
        pass
    
    if stock_type is None:
        message = await ctx.send(
            f"üìä **‡πÇ‡∏£‡∏ö‡∏±‡∏Ñ‡πÄ‡∏´‡∏•‡∏∑‡∏≠:**\n"
            f"üéÆ ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏Å‡∏°‡∏û‡∏≤‡∏™: **{gamepass_stock}**\n"
            f"üë• ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÇ‡∏£‡∏ö‡∏±‡∏Ñ‡∏Å‡∏•‡∏∏‡πà‡∏°: **{group_stock}**"
        )
        await asyncio.sleep(5)
        try:
            await message.delete()
        except:
            pass
    elif stock_type.lower() in ["gp", "gamepass", "‡πÄ‡∏Å‡∏°‡∏û‡∏≤‡∏™"]:
        if amount is None:
            message = await ctx.send(f"üéÆ Gamepass Stock ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: **{gamepass_stock}**")
            await asyncio.sleep(5)
            try:
                await message.delete()
            except:
                pass
        else:
            if amount < 0:
                await ctx.send("‚ùå ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô stock ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0")
                return
            
            gamepass_stock = amount
            await ctx.send(f"‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏Å‡∏°‡∏û‡∏≤‡∏™ ‡πÄ‡∏õ‡πá‡∏ô **{gamepass_stock}** ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß")
            await update_main_channel()
    
    elif stock_type.lower() in ["g", "group", "‡∏Å‡∏£‡∏∏‡πä‡∏õ"]:
        if amount is None:
            message = await ctx.send(f"üë• ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÇ‡∏£‡∏ö‡∏±‡∏Ñ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: **{group_stock}**")
            await asyncio.sleep(5)
            try:
                await message.delete()
            except:
                pass
        else:
            if amount < 0:
                await ctx.send("‚ùå ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô stock ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0")
                return
            
            group_stock = amount
            await ctx.send(f"‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÇ‡∏£‡∏ö‡∏±‡∏Ñ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÄ‡∏õ‡πá‡∏ô **{group_stock}** ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß")
            await update_main_channel()
    
    else:
        message = await ctx.send(
            "‚ùå ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:\n"
            "`!stock` - ‡πÄ‡∏ä‡πá‡∏Ñ stock ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n"
            "`!stock gp <‡∏à‡∏≥‡∏ô‡∏ß‡∏ô>` - ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Gamepass stock\n" 
            "`!stock group <‡∏à‡∏≥‡∏ô‡∏ß‡∏ô>` - ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Group stock"
        )
        await asyncio.sleep(5)
        try:
            await message.delete()
        except:
            pass

# ... (‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)

# --------------------------------------------------------------------------------------------------
# ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ö‡∏≠‡∏ó
print("üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ö‡∏≠‡∏ó...")
server_on()
try:
    bot.run(os.getenv("TOKEN"))
except Exception as e:
    print(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ö‡∏≠‡∏ó: {e}")

