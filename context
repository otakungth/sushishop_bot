import aiohttp
import os
import asyncio
import sys

async def update_commands_contexts():
    """
    ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó contexts ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Slash Commands ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÉ‡∏ô:
    - GUILD (0) - ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
    - BOT_DM (1) - DM ‡∏Å‡∏±‡∏ö‡∏ö‡∏≠‡∏ó
    - PRIVATE_CHANNEL (2) - DM ‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
    """
    token = os.getenv("TOKEN")
    app_id = os.getenv("APPLICATION_ID")
    
    if not token or not app_id:
        print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö TOKEN ‡∏´‡∏£‡∏∑‡∏≠ APPLICATION_ID ‡πÉ‡∏ô environment variables")
        print("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ TOKEN ‡πÅ‡∏•‡∏∞ APPLICATION_ID ‡πÉ‡∏ô Render Dashboard")
        return False
    
    headers = {
        "Authorization": f"Bot {token}",
        "Content-Type": "application/json"
    }
    
    try:
        async with aiohttp.ClientSession() as session:
            # ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            print("üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å Discord API...")
            async with session.get(
                f"https://discord.com/api/v10/applications/{app_id}/commands", 
                headers=headers
            ) as resp:
                if resp.status != 200:
                    error_text = await resp.text()
                    print(f"‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ: {resp.status} - {error_text}")
                    return False
                
                commands = await resp.json()
                print(f"‚úÖ ‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {len(commands)} ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á")
            
            # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó contexts ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
            success_count = 0
            fail_count = 0
            
            for cmd in commands:
                update_data = {
                    "contexts": [0, 1, 2]  # [GUILD, BOT_DM, PRIVATE_CHANNEL]
                }
                
                async with session.patch(
                    f"https://discord.com/api/v10/applications/{app_id}/commands/{cmd['id']}",
                    headers=headers,
                    json=update_data
                ) as resp:
                    if resp.status == 200:
                        print(f"‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó contexts ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö /{cmd['name']} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
                        success_count += 1
                    else:
                        error_text = await resp.text()
                        print(f"‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó /{cmd['name']}: {resp.status} - {error_text}")
                        fail_count += 1
            
            print(f"\nüìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó: ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à {success_count} ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß {fail_count} ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á")
            return success_count > 0
            
    except aiohttp.ClientError as e:
        print(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Discord API: {e}")
        return False
    except Exception as e:
        print(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î: {e}")
        return False

async def main():
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô‡πÅ‡∏ö‡∏ö standalone"""
    print("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó contexts ‡∏Ç‡∏≠‡∏á Slash Commands...")
    success = await update_commands_contexts()
    if success:
        print("‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó contexts ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå")
    else:
        print("‚ùå ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó contexts ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        sys.exit(1)

if __name__ == "__main__":
    asyncio.run(main())
